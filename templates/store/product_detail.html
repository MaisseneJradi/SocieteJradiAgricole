{% extends 'base.html' %}
{% load static %}
{% block content %}

<section class="section-content padding-y bg">
<div class="container">

<!-- ============================ COMPONENT 1 ================================= -->
<div class="card"> 
	<div class="row no-gutters"> 
		<aside class="col-md-6"> 
			<article class="gallery-wrap">  
				<div class="img-big-wrap mainImage"> 
				   <center><img id="product-image" src="{{ single_product.images.url}}"></center>
				</div> <!-- img-big-wrap.// --> 
			</article> <!-- gallery-wrap .end// --> 
			<ul class="thumb">
				<li>
					<a href="{{ single_product.images.url}}" target="mainImage"><img src="{{ single_product.images.url}}" alt="Product Image"></a>
					{% for i in product_gallery %}
					<a href="{{i.image.url}}" target="mainImage"><img src="{{i.image.url}}" alt="Product Image"></a>
					{% endfor %}
				</li>
			</ul>
		</aside> 
		<main class="col-md-6 border-left"> 
			<form action="{% url 'add_cart' single_product.id %}" method="POST"> 
				{% csrf_token %}
				<article class="content-body">  
					<h2 class="title">{{ single_product.product_name }}</h2>  
					{% if single_product.countReview > 0 %}
					<div class="rating-star">
						<span>
							<i class="fa
							{% if single_product.averageReview >= 1 %}
								fa-star
							{% elif single_product.averageReview >= 0.5 %}
								fa-star-half-o
							{% else %}
								fa-star-o
							{% endif %}" aria-hidden="true"></i>

							<i class="fa
							{% if single_product.averageReview >= 2 %}
								fa-star
							{% elif single_product.averageReview >= 1.5 %}
								fa-star-half-o
							{% else %}
								fa-star-o
							{% endif %}" aria-hidden="true"></i>

							<i class="fa
							{% if single_product.averageReview >= 3 %}
								fa-star
							{% elif single_product.averageReview >= 2.5 %}
								fa-star-half-o
							{% else %}
								fa-star-o
							{% endif %}" aria-hidden="true"></i>

							<i class="fa
							{% if single_product.averageReview >= 4 %}
								fa-star
							{% elif single_product.averageReview >= 3.5 %}
								fa-star-half-o
							{% else %}
								fa-star-o
							{% endif %}" aria-hidden="true"></i>

							<i class="fa
							{% if single_product.averageReview >= 5 %}
								fa-star
							{% elif single_product.averageReview >= 4.5 %}
								fa-star-half-o
							{% else %}
								fa-star-o
							{% endif %}" aria-hidden="true"></i>
						<span>{{single_product.countReview}} Avis</span>
						</span>
					</div>
					{% endif %}
					
					<div class="mb-3">  
						{% if single_product.variation_set.all %} 
							<!-- Afficher le prix du premier conditionnement par défaut -->
							<var class="price h4" id="product-price">{{ single_product.price }}TND</var>  
						{% else %} 
							<var class="price h4" id="product-price">{{ single_product.price }}TND</var> 
						{% endif %} 
					</div>   
					
					<p>{{single_product.description}}</p>   
					<hr> 
					
					<div class="row"> 
						{% if single_product.variation_set.all %} 
							<div class="item-option-select"> 
								<h6>Conditionnement</h6> 
								<select name="conditionnement" class="form-control" id="variation-select" required> 
									<option value="" disabled selected>Choisissez un conditionnement</option>								 
									{% for i in single_product.variation_set.conditionnement %}
										<option value="{{ i.variation_value }}"
											data-price="{{ i.variation_price }}"
											{% if i.variation_image %}
												data-image="{{ i.variation_image.url }}"
											{% else %}
												data-image=""
											{% endif %}>
											
											{{ i.variation_value }}
    									</option>
									{% endfor %}

								</select> 
							</div> 
						{% endif %} 
					</div> <!-- row.// --> 
					<hr> 
					
					{% if single_product.stock <= 0 %} 
						<h5 class='text-danger'>Hors stock</h5> 
					{% else %} 
						<button type="submit" class="btn btn-primary"> 
							<span class="text">Ajouter au panier</span> 
							<i class="fas fa-shopping-cart"></i>  
						</button> 
					{% endif %}  
				</article> <!-- product-info-aside .// --> 
			</form>	 
		</main> <!-- col.// --> 
	</div> <!-- row.// --> 
</div> <!-- card.// -->

<!-- JavaScript pour la mise à jour dynamique du prix -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const variationSelect = document.getElementById('variation-select');
    const priceElement = document.getElementById('product-price');
    const imageElement = document.getElementById('product-image');

    if (variationSelect && priceElement) {
        variationSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const price = selectedOption.getAttribute('data-price');
            const image = selectedOption.getAttribute('data-image');

            if (price) {
                priceElement.textContent = price + 'TND';
                priceElement.style.transition = 'all 0.3s ease';
                priceElement.style.transform = 'scale(1.05)';
                priceElement.style.color = '#28a745';
                setTimeout(function() {
                    priceElement.style.transform = 'scale(1)';
                    priceElement.style.color = '';
                }, 300);
            }

            if (image && imageElement) {
                imageElement.src = image;
            } else {
                imageElement.src = "{{ single_product.images.url }}"; // Image par défaut
            }
        });
    }
});
</script>

<!-- ============================ COMPONENT 1 END .// ================================= -->

<br>

<div class="row">
			<div class="col-md-9">




	<form action="{% url 'submit_review' single_product.id %}" method="POST">

		{% csrf_token %}
		<h5>Laissez votre avis</h5>
		<div>
			<!--Rating stars-->
			<label>Comment évaluez-vous ce produit ?</label>
			<br>
			<div class="rate">
				<input type="radio" name="rating" id="rating10" value="5" required /><label for="rating10" title="5"></label>
				<input type="radio" name="rating" id="rating9" value="4.5" required /><label for="rating9" title="4.5" class="half"></label>
				<input type="radio" name="rating" id="rating8" value="4" required /><label for="rating8" title="4"></label>
				<input type="radio" name="rating" id="rating7" value="3.5" required /><label for="rating7" title="3.5" class="half"></label>
				<input type="radio" name="rating" id="rating6" value="3" required /><label for="rating6" title="3"></label>
				<input type="radio" name="rating" id="rating5" value="2.5" required /><label for="rating5" title="2.5" class="half"></label>
				<input type="radio" name="rating" id="rating4" value="2" required /><label for="rating4" title="2"></label>
				<input type="radio" name="rating" id="rating3" value="1.5" required /><label for="rating3" title="1.5" class="half"></label>
				<input type="radio" name="rating" id="rating2" value="1" required /><label for="rating2" title="1"></label>
				<input type="radio" name="rating" id="rating1" value="0.5" required /><label for="rating1" title="0.5" class="half"></label>
			</div>
			<br>
			Avis:
			<textarea name="review" rows="4" class="form-control"></textarea>
			<br>
			{% if user.is_authenticated %}
				{% if orderproduct %}
					<input type="submit" value="Soumettre l’avis" class="btn btn-primary">
				{% else %}
					<p>Vous devez avoir acheté ce produit pour publier un avis.</p>
					
				{% endif %}
			{% else %}
				<p>Vous devez être connecté pour publier un avis. <span><a href="{% url 'login' %}">Se connecter</a></span></p>
			{% endif %}
		</div>
	{% include 'includes/alerts.html' %}	
	</form>
	<br>
	<header class="section-heading">
		{% if single_product.countReview > 0 %}
		<h3>Avis des clients </h3>  

		<div class="rating-star">
			<span>
				<i class="fa
				{% if single_product.averageReview >= 1 %}
					fa-star
				{% elif single_product.averageReview >= 0.5 %}
					fa-star-half-o
				{% else %}
					fa-star-o
				{% endif %}" aria-hidden="true"></i>

				<i class="fa
				{% if single_product.averageReview >= 2 %}
					fa-star
				{% elif single_product.averageReview >= 1.5 %}
					fa-star-half-o
				{% else %}
					fa-star-o
				{% endif %}" aria-hidden="true"></i>

				<i class="fa
				{% if single_product.averageReview >= 3 %}
					fa-star
				{% elif single_product.averageReview >= 2.5 %}
					fa-star-half-o
				{% else %}
					fa-star-o
				{% endif %}" aria-hidden="true"></i>

				<i class="fa
				{% if single_product.averageReview >= 4 %}
					fa-star
				{% elif single_product.averageReview >= 3.5 %}
					fa-star-half-o
				{% else %}
					fa-star-o
				{% endif %}" aria-hidden="true"></i>

				<i class="fa
				{% if single_product.averageReview >= 5 %}
					fa-star
				{% elif single_product.averageReview >= 4.5 %}
					fa-star-half-o
				{% else %}
					fa-star-o
				{% endif %}" aria-hidden="true"></i>
			<span>{{single_product.countReview}} Avis</span>

			</span>
		</div>

	</header>
	{% for review in reviews %}
		<article class="box mb-3">
			<div class="icontext w-100">
				<img src="https://ui-avatars.com/api/?name={{ user.first_name|default:"U" }}+{{ user.last_name|default:"S" }}&background=0D8ABC&color=fff&rounded=true&size=32" class="img-xs icon rounded-circle shadow-sm border" alt="Avatar">
				<div class="text">
					<span class="date text-muted float-md-right">{{ review.updated_at|date:"d/m/Y" }} </span>  
					<h6 class="mb-1">{{review.user.full_name}} </h6>
					<div class="rating-star">
						<span>
							<i class="fa{% if review.rating >= 1 %}
								fa-star
							{% elif review.rating >= 0.5 %}
								fa-star-half-o
							{% else %}
								fa-star-o
							{% endif %}"
							aria-hidden="true"></i>

							<i class="fa
							{% if review.rating >= 2 %}
								fa-star
							{% elif review.rating >= 1.5 %}
								fa-star-half-o
							{% else %}
								fa-star-o
							{% endif %}"
							aria-hidden="true"></i>

							<i class="fa
							{% if review.rating >= 3 %}
								fa-star
							{% elif review.rating >= 2.5 %}
								fa-star-half-o
							{% else %}
								fa-star-o
							{% endif %}"
							aria-hidden="true"></i>

							<i class="fa
							{% if review.rating >= 4 %}
								fa-star
							{% elif review.rating >= 3.5 %}
								fa-star-half-o
							{% else %}
								fa-star-o
							{% endif %}"
							aria-hidden="true"></i>

							<i class="fa
							{% if review.rating >= 5 %}
								fa-star
							{% elif review.rating >= 4.5 %}
								fa-star-half-o
							{% else %}
								fa-star-o
							{% endif %}"
							aria-hidden="true"></i>
						</span>
					</div>

				</div>
			</div> <!-- icontext.// -->
			<div class="mt-3">
			
				<p>
					{{review.review}}
				</p>	
			</div>
		</article>
	{% endfor %}	
	
	{% endif %}

	</div> <!-- col.// -->
</div> <!-- row.// -->


</div> <!-- container .//  -->
</section>

<!-- ========================= SECTION CONTENT END// ========================= -->
{% endblock %}